name: Windows - RDP Connection

on:
  workflow_dispatch:

jobs:
  build:
    name: Start Building & Connect RDP
    runs-on: windows-latest
    timeout-minutes: 999999


    env:
      RDP_IP: ${{ secrets.RDP_IP }}
      RDP_USER: ${{ secrets.RDP_USER }}
      RDP_PASS: ${{ secrets.RDP_PASS }}


    steps:
      - name: Download & Install Essentials
        run: |
          # Получаем прямую ссылку через API Яндекс Диска
          $apiUrl = "https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=https%3A%2F%2Fdisk.yandex.ru%2Fd%2FEwX3oB4aaL00SA"
          $response = Invoke-RestMethod -Uri $apiUrl -Method Get
          $downloadUrl = $response.href

          Invoke-WebRequest -Uri $downloadUrl -OutFile "Downloads.bat"


          # Проверяем, что файл корректный
          $content = Get-Content -Path "Downloads.bat" -Raw
          if (-not $content.Contains("@echo off")) {
              Write-Error "Invalid BAT file downloaded!"
              exit 1
          }

          cmd /c Downloads.bat


      - name: Prepare RDP Configuration
        run: |
          $RDP_FILE = "$env:TEMP\auto_rdp.rdp"
          @"full address:s:$env:RDP_IP`n! | Out-File -FilePath $RDP_FILE -Encoding ASCII
          @"username:s:$env:RDP_USER`n! | Out-File -FilePath $RDP_FILE -Append -Encoding ASCII
          @"negotiate authentication:i:1`n! | Out-File -FilePath $RDP_FILE -Append -Encoding ASCII
          @"autoconnect:i:1`n! | Out-File -FilePath $RDP_FILE -Append -Encoding ASCII
          @"prompt for credentials:i:0`n! | Out-File -FilePath $RDP_FILE -Append -Encoding ASCII


          cmdkey /generic:$env:RDP_IP /user:$env:RDP_USER /pass:$env:RDP_PASS


          reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
          netsh advfirewall firewall set rule group="Remote Desktop" new enable=Yes


          start "" mstsc.exe "$RDP_FILE"


      - name: Keep Session Alive
        run: timeout /t 3600


      - name: Cleanup
        if: always()
        run: Remove-Item -Path "$env:TEMP\auto_rdp.rdp" -ErrorAction SilentlyContinue
